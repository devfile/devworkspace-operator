name: "Adds all postStart events to containers"

input:
  devfile:
    commands:
      - id: test-postStart-1
        exec:
          component: test-component-1
          commandLine: "echo 'hello world 1'"
      - id: test-postStart-2
        exec:
          component: test-component-2
          commandLine: "echo 'hello world 2'"
          workingDir: "/tmp/test-dir"
    events:
      postStart:
        - test-postStart-1
        - test-postStart-2

  containers:
    - name: test-component-1
      image: test-img
    - name: test-component-2
      image: test-img
    - name: test-component-3
      image: test-img

output:
  containers:
    - name: test-component-1
      image: test-img
      lifecycle:
        postStart:
          exec:
            command:
              - /bin/sh
              - -c
              - |
                {
                  # This script block ensures its exit code is preserved
                  # while its stdout and stderr are tee'd.
                  _script_to_run() {
                    
                export POSTSTART_TIMEOUT_DURATION="0"
                export POSTSTART_KILL_AFTER_DURATION="5"

                _TIMEOUT_COMMAND_PART=""
                _WAS_TIMEOUT_USED="false" # Use strings "true" or "false" for shell boolean

                if command -v timeout >/dev/null 2>&1; then
                  echo "[postStart hook] Executing commands with timeout: ${POSTSTART_TIMEOUT_DURATION} seconds, kill after: ${POSTSTART_KILL_AFTER_DURATION} seconds" >&2
                  _TIMEOUT_COMMAND_PART="timeout --preserve-status --kill-after=${POSTSTART_KILL_AFTER_DURATION} ${POSTSTART_TIMEOUT_DURATION}"
                  _WAS_TIMEOUT_USED="true"
                else
                  echo "[postStart hook] WARNING: 'timeout' utility not found. Executing commands without timeout." >&2
                fi

                # Execute the user's script
                ${_TIMEOUT_COMMAND_PART} /bin/sh -c 'set -e
                echo '\''hello world 1'\'''
                exit_code=$?

                # Check the exit code based on whether timeout was attempted
                if [ "$_WAS_TIMEOUT_USED" = "true" ]; then
                  if [ $exit_code -eq 143 ]; then # 128 + 15 (SIGTERM)
                    echo "[postStart hook] Commands terminated by SIGTERM (likely timed out after ${POSTSTART_TIMEOUT_DURATION}s). Exit code 143." >&2
                  elif [ $exit_code -eq 137 ]; then # 128 + 9 (SIGKILL)
                    echo "[postStart hook] Commands forcefully killed by SIGKILL (likely after --kill-after ${POSTSTART_KILL_AFTER_DURATION}s expired). Exit code 137." >&2
                  elif [ $exit_code -ne 0 ]; then # Catches any other non-zero exit code
                    echo "[postStart hook] Commands failed with exit code $exit_code." >&2
                  else
                    echo "[postStart hook] Commands completed successfully within the time limit." >&2
                  fi
                else
                  if [ $exit_code -ne 0 ]; then
                    echo "[postStart hook] Commands failed with exit code $exit_code (no timeout)." >&2
                  else
                    echo "[postStart hook] Commands completed successfully (no timeout)." >&2
                  fi
                fi

                exit $exit_code
                 # This will be replaced by scriptWithTimeout
                  }
                  _script_to_run
                } 1> >(tee -a "/tmp/poststart-stdout.txt") 2> >(tee -a "/tmp/poststart-stderr.txt" >&2)
    - name: test-component-2
      image: test-img
      lifecycle:
        postStart:
          exec:
            command:
              - /bin/sh
              - -c
              - |
                {
                  # This script block ensures its exit code is preserved
                  # while its stdout and stderr are tee'd.
                  _script_to_run() {
                    
                export POSTSTART_TIMEOUT_DURATION="0"
                export POSTSTART_KILL_AFTER_DURATION="5"

                _TIMEOUT_COMMAND_PART=""
                _WAS_TIMEOUT_USED="false" # Use strings "true" or "false" for shell boolean

                if command -v timeout >/dev/null 2>&1; then
                  echo "[postStart hook] Executing commands with timeout: ${POSTSTART_TIMEOUT_DURATION} seconds, kill after: ${POSTSTART_KILL_AFTER_DURATION} seconds" >&2
                  _TIMEOUT_COMMAND_PART="timeout --preserve-status --kill-after=${POSTSTART_KILL_AFTER_DURATION} ${POSTSTART_TIMEOUT_DURATION}"
                  _WAS_TIMEOUT_USED="true"
                else
                  echo "[postStart hook] WARNING: 'timeout' utility not found. Executing commands without timeout." >&2
                fi

                # Execute the user's script
                ${_TIMEOUT_COMMAND_PART} /bin/sh -c 'set -e
                cd '\''/tmp/test-dir'\'' && echo '\''hello world 2'\'''
                exit_code=$?

                # Check the exit code based on whether timeout was attempted
                if [ "$_WAS_TIMEOUT_USED" = "true" ]; then
                  if [ $exit_code -eq 143 ]; then # 128 + 15 (SIGTERM)
                    echo "[postStart hook] Commands terminated by SIGTERM (likely timed out after ${POSTSTART_TIMEOUT_DURATION}s). Exit code 143." >&2
                  elif [ $exit_code -eq 137 ]; then # 128 + 9 (SIGKILL)
                    echo "[postStart hook] Commands forcefully killed by SIGKILL (likely after --kill-after ${POSTSTART_KILL_AFTER_DURATION}s expired). Exit code 137." >&2
                  elif [ $exit_code -ne 0 ]; then # Catches any other non-zero exit code
                    echo "[postStart hook] Commands failed with exit code $exit_code." >&2
                  else
                    echo "[postStart hook] Commands completed successfully within the time limit." >&2
                  fi
                else
                  if [ $exit_code -ne 0 ]; then
                    echo "[postStart hook] Commands failed with exit code $exit_code (no timeout)." >&2
                  else
                    echo "[postStart hook] Commands completed successfully (no timeout)." >&2
                  fi
                fi

                exit $exit_code
                 # This will be replaced by scriptWithTimeout
                  }
                  _script_to_run
                } 1> >(tee -a "/tmp/poststart-stdout.txt") 2> >(tee -a "/tmp/poststart-stderr.txt" >&2)

    - name: test-component-3
      image: test-img
